name: Unittest

on:
  workflow_dispatch:

  push:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'milvus-proto/**'
      - 'build.rs'
      - '.github/**'
      - 'docker-compose.yml'

  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'milvus-proto/**'
      - 'build.rs'
      - '.github/**'
      - 'docker-compose.yml'

jobs:
  # This workflow contains a single job called "build_and_test"
  build_and_test:
    name: Unittest AMD64 Ubuntu
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
        with:
          submodules: 'true'

      # do not put docker volume in the source code directory
      - name: Setup Milvus
        run: DOCKER_VOLUME_DIRECTORY=../ docker compose up -d && sleep 15s

      - name: Setup protoc
        uses: arduino/setup-protoc@v1.1.2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      # Runs a single command using the runners shell
      - name: Run Unittest
        run: RUST_BACKTRACE=1 cargo test
      # - name: Upload coverage to Codecov
      #   if: github.repository == 'milvus-io/milvus-sdk-rust'
      #   uses: codecov/codecov-action@v1
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }} 
      #     file: ./coverage.project.out
      #     name: ubuntu-${{ matrix.ubuntu }}-unittests
